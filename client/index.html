<!DOCTYPE html>
<html lang="en">
  <head>
    <title>The Game</title>

    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>

    <script type="text/javascript" src="js/knockoutjs.3.5.0.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Stylesheet -->
    <link href="css/style.css" rel="stylesheet" type="text/css">
  </head>

  <body>
    <div class="login-container">
      <div class="login-box drop-shadow">
        <div class="alert alert-info" style="width: 100%;" data-bind="visible: message, text: message"></div>

        <h2 class="login-title">Login</h2>
        <div class="">
          <input data-bind="value: email, valueUpdate: 'afterkeydown'" type="text" class="form-control" placeholder="Email" aria-label="Email" aria-describedby="">
          <input id="login-password" data-bind="value: password, valueUpdate: 'afterkeydown'" type="text" class="form-control form-password" placeholder="Password" aria-label="Password" aria-describedby="">
        </div>
        <a href="#0" class="btn login-button" data-bind="click: function() { login(); }">LOGIN</a>

        <a href="#0" class="btn login-button" data-bind="click: function() { getMe(); }">me</a>

        <div class="trademark">
            <p>Ian Burns 2017</p>
          </div>
      </div>
    </div>
  </body>

  <script type="text/javascript">

    var vm = function() {
      var self = this;

      self.email = ko.observable('');
      self.password = ko.observable('');

      self.message = ko.observable('');

      self.login = function() {
        $.ajax({
          type: "POST",
          url: "http://localhost:3000/login",
          data: { email: self.email(), password: self.password()},
          success: function(result){
            console.log(result);
          },
          error: function(XMLHttpRequest, textStatus, errorThrown) {
            console.log(textStatus);
          }
        });
      }

      self.getMe = function() {
        $.ajax({
          type: "GET",
          url: "http://localhost:3000/me",
          data: {},
          success: function(result){
            console.log(result);
          },
          error: function(XMLHttpRequest, textStatus, errorThrown) {
            if (errorThrown === "Unauthorized") {
              window.location.href = "index.html?message=relog";
            }
          }
        });
      }

      // button bindings
      document.getElementById('login-password').onkeydown = function(event) {
        if (event.keyCode == 13) {
            self.login();
        }
      }

      return self;
    }

    var viewModel = new vm();
    ko.applyBindings(viewModel);

    $(document).ready(function() {
      var url = window.location.href;
      if (url) {
        var paramsString = window.location.href.split("?")[1];
        var paramValues = paramsString.split("&");
        var params = new Array();
        paramValues.forEach(function (param) {
            var paramValue = param.split("=");
            params[paramValue[0]] = paramValue[1];
        });
        if (params['message'] === "relog") {
          viewModel.message("Please log in again");
        }
      }
    });
  </script>

  </html>
